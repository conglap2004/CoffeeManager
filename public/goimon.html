<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Gọi Món - CoffeeManager</title>
    <link rel="icon" href="https://dynamic.design.com/asset/logo/a58dbcd0-c6c4-4efc-9344-8f1cb61e134f/logo-search-grid-2x?logoTemplateVersion=1&v=638817514014730000&text=coffee">
    <link href="main.css" rel="stylesheet">

</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo">
            <img src="https://dynamic.design.com/asset/logo/a58dbcd0-c6c4-4efc-9344-8f1cb61e134f/logo-search-grid-2x?logoTemplateVersion=1&v=638817514014730000&text=coffee" alt="Coffee icon">
            CoffeeManager
        </div>
        <div class="nav-menu">
            <ul class="Lv1">
                <li><img class="icon1" src="https://img.icons8.com/?size=100&id=2797&format=png" width="30"><a href="index.html">Trang chủ</a></li>
                <li><img class="icon1" src="https://img.icons8.com/?size=100&id=8287&format=png" width="30"> Cửa Hàng
                    <ul class="Lv2">
                         <li><a href="nhanvien.html">Quản lý nhân viên</a></li>
                        <li><a href="khachhang.html">Quản lý khách hàng </a></li>
                        <li><a href="goimon.html">Màn hình Order</a></li>
                    </ul>
                </li>
                <li><img class="icon1" src="https://img.icons8.com/?size=100&id=7977&format=png" width="30"><a href="Thuchi.html"> Thu Chi </a> </li>
                <li><img class="icon1" src="https://img.icons8.com/?size=100&id=12428&format=png" width="30">Hàng Hóa 
                    <ul class="Lv2">
                        <li><a href="Thucdon.html">Sản Phẩm</a></li>
                        <li><a href="danhmuc.html">Danh mục </a></li>
                    </ul>
                </li>
                 <li><img class="icon1" src="https://img.icons8.com/?size=100&id=7819&format=png" width="30"><a href="Dangnhap.html"> Đăng xuất </a></li>
            </ul>
        </div>
    </div>
    
    <!-- Loading Message -->
    <div class="loading" id="loadingMessage" style="display: none; text-align: center; padding: 20px;">
        <p>Đang tải dữ liệu...</p>
    </div>
    
    <!-- Table Info -->
    <div class="table-info">
        <div>
            <h2 id="table-name">Bàn 01</h2>
            <p style="margin: 5px 0 0 0; color: #666;">Thời gian: <span id="start-time">--:--</span></p>
        </div>
        <div class="table-status">Đang phục vụ</div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Menu Section -->
        <div class="menu-section">
            <h3>Thực đơn</h3>
            
            <!-- Search Bar -->
            <div class="search-bar">
                <input type="text" class="search-input" placeholder="Tìm kiếm món..." id="search-input">
            </div>
            
            <!-- Menu Categories -->
            <div class="menu-categories" id="menu-categories">
                <button class="category-btn active" data-category="all">Tất cả</button>
                <!-- Categories will be loaded dynamically -->
            </div>
            
            <!-- Menu Items -->
            <div class="menu-grid" id="menu-grid">
                <!-- Menu items will be generated by JavaScript -->
            </div>
        </div>
        
        <!-- Order Section -->
        <div class="order-section">
            <h3>Đơn hàng</h3>
            
            <div class="order-list" id="order-list">
                <div class="empty-order">
                    <img src="https://img.icons8.com/ios/50/shopping-cart.png" alt="Empty cart">
                    <p>Chưa có món nào được chọn</p>
                </div>
            </div>
            
            <div class="order-summary" id="order-summary" style="display: none;">
                <div class="summary-row">
                    <span>Tạm tính:</span>
                    <span id="subtotal">0đ</span>
                </div>
                <div class="summary-row">
                    <span>VAT (10%):</span>
                    <span id="tax">0đ</span>
                </div>
                <div class="summary-row total-row">
                    <span>Tổng cộng:</span>
                    <span id="total">0đ</span>
                </div>
            </div>
            
            <div class="payment-buttons">
                <button class="payment-btn btn-back" onclick="goBack()">Quay lại</button>
                <button class="payment-btn btn-pay" onclick="processPayment()" id="pay-btn" disabled>Thanh toán</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let menuData = [];
        let currentOrder = [];
        let currentCategory = 'all';
        let availableCategories = [];

        const categoryDisplayNames = {
            coffee: "Cà phê",
            cacao: "Cacao", 
            special: "Đặc biệt",
            tea: "Trà",
            smoothie: "Sinh tố",
            snack: "Bánh kẹo",
            milk: "Sữa"
        };

        // API functions
        async function fetchProducts() {
            try {
                showLoading(true);
                const response = await fetch('http://localhost:3000/api/products/all');
                const result = await response.json();
                
                if (result.success) {
                    // Transform database data to match frontend format
                    menuData = result.data.map(product => ({
                        id: product._id,
                        name: product.name,
                        category: product.category,
                        price: product.price,
                        description: product.description || '',
                        image: product.image || 'https://via.placeholder.com/300x200?text=No+Image'
                    }));
                    
                    // Get unique categories from products
                    availableCategories = [...new Set(menuData.map(item => item.category))];
                    
                    renderCategories();
                    renderMenu();
                } else {
                    console.error('Không thể tải danh sách sản phẩm:', result.message);
                    showErrorMessage('Không thể tải thực đơn. Vui lòng thử lại sau.');
                }
            } catch (error) {
                console.error('Lỗi khi tải sản phẩm:', error);
                showErrorMessage('Lỗi kết nối. Vui lòng kiểm tra server và thử lại.');
            } finally {
                showLoading(false);
            }
        }

        function showLoading(show) {
            document.getElementById('loadingMessage').style.display = show ? 'block' : 'none';
        }

        function showErrorMessage(message) {
            const menuGrid = document.getElementById('menu-grid');
            menuGrid.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #666; grid-column: 1/-1;">
                    <p>${message}</p>
                    <button onclick="fetchProducts()" style="margin-top: 10px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Thử lại
                    </button>
                </div>
            `;
        }

        // Render categories dynamically
        function renderCategories() {
            const categoriesContainer = document.getElementById('menu-categories');
            
            // Always start with "Tất cả" button
            let categoriesHTML = '<button class="category-btn active" data-category="all">Tất cả</button>';
            
            // Add buttons for available categories
            availableCategories.forEach(category => {
                const displayName = categoryDisplayNames[category] || category.charAt(0).toUpperCase() + category.slice(1);
                categoriesHTML += `<button class="category-btn" data-category="${category}">${displayName}</button>`;
            });
            
            categoriesContainer.innerHTML = categoriesHTML;
            
            // Add event listeners to new category buttons
            categoriesContainer.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentCategory = this.dataset.category;
                    renderMenu();
                });
            });
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Get table info from URL params or localStorage
            const urlParams = new URLSearchParams(window.location.search);
            const tableName = urlParams.get('table') || 'Bàn 01';
            document.getElementById('table-name').textContent = tableName;
            
            // Set start time
            const now = new Date();
            document.getElementById('start-time').textContent = now.toLocaleTimeString('vi-VN', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Load products from database
            fetchProducts();
            
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
        });
        
        // Update current time
        function updateCurrentTime() {
            const now = new Date();
            const currentTimeElement = document.getElementById('current-time');
            if (currentTimeElement) {
                currentTimeElement.textContent = now.toLocaleTimeString('vi-VN');
            }
        }
        
        // Render menu items
        function renderMenu() {
            const menuGrid = document.getElementById('menu-grid');
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            
            if (menuData.length === 0) {
                menuGrid.innerHTML = '<p style="text-align: center; padding: 40px; grid-column: 1/-1;">Đang tải thực đơn...</p>';
                return;
            }
            
            const filteredMenu = menuData.filter(item => {
                const matchesCategory = currentCategory === 'all' || item.category === currentCategory;
                const matchesSearch = item.name.toLowerCase().includes(searchTerm) || 
                                    item.description.toLowerCase().includes(searchTerm);
                return matchesCategory && matchesSearch;
            });
            
            if (filteredMenu.length === 0) {
                menuGrid.innerHTML = '<p style="text-align: center; padding: 40px; grid-column: 1/-1;">Không tìm thấy sản phẩm nào.</p>';
                return;
            }
            
            menuGrid.innerHTML = filteredMenu.map(item => `
                <div class="menu-item" onclick="addToOrder('${item.id}')">
                    <img src="${item.image}" alt="${item.name}" onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
                    <h4>${item.name}</h4>
                    <p>${item.description}</p>
                    <div class="menu-item-footer">
                        <span class="price">${formatPrice(item.price)}</span>
                        <button class="add-btn" onclick="event.stopPropagation(); addToOrder('${item.id}')">Thêm</button>
                    </div>
                </div>
            `).join('');
        }
        
        // Search functionality
        document.getElementById('search-input').addEventListener('input', renderMenu);
        
        // Add item to order
        function addToOrder(itemId) {
            const item = menuData.find(i => i.id === itemId);
            if (!item) return;
            
            const existingItem = currentOrder.find(orderItem => orderItem.id === itemId);
            
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                currentOrder.push({
                    ...item,
                    quantity: 1
                });
            }
            
            renderOrder();
        }
        
        // Remove item from order
        function removeFromOrder(itemId) {
            currentOrder = currentOrder.filter(item => item.id !== itemId);
            renderOrder();
        }
        
        // Update quantity
        function updateQuantity(itemId, change) {
            const item = currentOrder.find(orderItem => orderItem.id === itemId);
            if (!item) return;
            
            item.quantity += change;
            
            if (item.quantity <= 0) {
                removeFromOrder(itemId);
            } else {
                renderOrder();
            }
        }
        
        // Render order
        function renderOrder() {
            const orderList = document.getElementById('order-list');
            const orderSummary = document.getElementById('order-summary');
            const payBtn = document.getElementById('pay-btn');
            
            if (currentOrder.length === 0) {
                orderList.innerHTML = `
                    <div class="empty-order">
                        <img src="https://img.icons8.com/ios/50/shopping-cart.png" alt="Empty cart">
                        <p>Chưa có món nào được chọn</p>
                    </div>
                `;
                orderSummary.style.display = 'none';
                payBtn.disabled = true;
                return;
            }
            
            orderList.innerHTML = currentOrder.map(item => `
                <div class="order-item">
                    <div class="item-info">
                        <div class="item-name">${item.name}</div>
                        <div class="item-price">${formatPrice(item.price)}</div>
                    </div>
                    <div class="quantity-controls">
                        <button class="qty-btn" onclick="updateQuantity('${item.id}', -1)">-</button>
                        <span class="quantity">${item.quantity}</span>
                        <button class="qty-btn" onclick="updateQuantity('${item.id}', 1)">+</button>
                        <button class="remove-btn" onclick="removeFromOrder('${item.id}')">Xóa</button>
                    </div>
                </div>
            `).join('');
            
            // Calculate totals
            const subtotal = currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const tax = Math.round(subtotal * 0.1);
            const total = subtotal + tax;
            
            document.getElementById('subtotal').textContent = formatPrice(subtotal);
            document.getElementById('tax').textContent = formatPrice(tax);
            document.getElementById('total').textContent = formatPrice(total);
            
            orderSummary.style.display = 'block';
            payBtn.disabled = false;
        }
        
        // Format price
        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(price);
        }
        
        // Process payment
        async function processPayment() {
            if (currentOrder.length === 0) return;

            const today = new Date().toISOString().split('T')[0];
            const totalAmount = currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const tax = Math.round(totalAmount * 0.1);
            const grandTotal = totalAmount + tax;

            const transaction = {
                type: 'income',
                category: 'Bán cà phê',
                amount: grandTotal,
                description: `Thanh toán gọi món từ ${document.getElementById('table-name').textContent} - ${currentOrder.map(item => `${item.name} (${item.quantity})`).join(', ')}`,
                date: today
            };

            try {
                const response = await fetch('http://localhost:3000/api/transactions/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(transaction)
                });
                
                if (response.ok) {
                    currentOrder = [];
                    renderOrder();
                    alert(' Thanh toán thành công!');
                    goBack();
                } else {
                    console.error('Lỗi khi lưu giao dịch');
                }
            } catch (err) {
                console.error('Lỗi:', err);
            }
        }
        
        
        
        // Handle keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                goBack();
            } else if (e.ctrlKey && e.key === 'Enter') {
                processPayment();
            }
        });
        
        // Auto refresh menu data every 30 seconds to get latest products
        setInterval(fetchProducts, 30000);
        
    </script>
</body>
</html>