<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Thu Chi - CoffeeManager</title>
    <link href="main.css" rel="stylesheet">
    <link rel="icon" href ="https://dynamic.design.com/asset/logo/a58dbcd0-c6c4-4efc-9344-8f1cb61e134f/logo-search-grid-2x?logoTemplateVersion=1&v=638817514014730000&text=coffee">
  
</head>
<body>
    <div class="header">
        <div class="logo">
            <img src="https://dynamic.design.com/asset/logo/a58dbcd0-c6c4-4efc-9344-8f1cb61e134f/logo-search-grid-2x?logoTemplateVersion=1&v=638817514014730000&text=coffee" alt="Coffee icon">
            CoffeeManager
        </div>
        <div class="nav-menu">
            <ul class="Lv1">
                <li><img class="icon1" src="https://img.icons8.com/?size=100&id=2797&format=png" width="30"><a href="index.html"> Trang ch·ªß</a></li>
                <li><img class="icon1" src="https://img.icons8.com/?size=100&id=8287&format=png" width="30"> C·ª≠a H√†ng
                    <ul class="Lv2">
                         <li><a href="nhanvien.html">Qu·∫£n l√Ω nh√¢n vi√™n</a></li>
                        <li><a href="khachhang.html">Qu·∫£n l√Ω kh√°ch h√†ng </a></li>
                        <li><a href="datban.html">M√†n h√¨nh Order</a></li>
                    </ul>
                </li>
                <li><img class="icon1" src="https://img.icons8.com/?size=100&id=7977&format=png" width="30"><a href="Thuchi.html"> Thu Chi</a> </li>
                <li><img class="icon1" src="https://img.icons8.com/?size=100&id=12428&format=png" width="30">H√†ng H√≥a 
                    <ul class="Lv2">
                        <li><a href="Thucdon.html">S·∫£n Ph·∫©m</a></li>
                        <li><a href="danhmuc.html">Danh m·ª•c </a> </li>
                    </ul>
                </li>
                <li><img class="icon1" src="https://img.icons8.com/?size=100&id=7819&format=png" width="30"><a href="Dangnhap.html">ƒêƒÉng xu·∫•t </a></li>


            </ul>
        </div>
    </div>
    

        <!-- Th·ªëng k√™ t·ªïng quan -->
        <div class="stats-grid">
            <div class="stat-card">
                <div>T·ªïng Thu Nh·∫≠p</div>
                <div class="stat-number income" id="totalIncome">0‚Ç´</div>
            </div>
            <div class="stat-card">
                <div>T·ªïng Chi Ph√≠</div>
                <div class="stat-number expense" id="totalExpense">0‚Ç´</div>
            </div>
            <div class="stat-card">
                <div>L·ª£i Nhu·∫≠n</div>
                <div class="stat-number profit" id="totalProfit">0‚Ç´</div>
            </div>
            <div class="stat-card">
                <div>Giao D·ªãch H√¥m Nay</div>
                <div class="stat-number" id="todayTransactions">0</div>
            </div>
        </div>

        <!-- Dashboard ch√≠nh -->
        <div class="dashboard">
            <!-- Form th√™m giao d·ªãch -->
            <div class="card">
                <h3> Th√™m Giao D·ªãch M·ªõi</h3>
                <form id="transactionForm">
                    <div class="form-group">
                        <label for="type">Lo·∫°i giao d·ªãch:</label>
                        <select id="type" required>
                            <option value="">Ch·ªçn lo·∫°i giao d·ªãch</option>
                            <option value="income">Thu nh·∫≠p</option>
                            <option value="expense">Chi ph√≠</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="category">Danh m·ª•c:</label>
                        <select id="category" required>
                            <option value="">Ch·ªçn danh m·ª•c</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="amount">S·ªë ti·ªÅn (VNƒê):</label>
                        <input type="number" id="amount" min="0" required placeholder="Nh·∫≠p s·ªë ti·ªÅn">
                    </div>
                    
                    <div class="form-group">
                        <label for="description">M√¥ t·∫£:</label>
                        <textarea id="description" rows="3" placeholder="M√¥ t·∫£ chi ti·∫øt (kh√¥ng b·∫Øt bu·ªôc)"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="date">Ng√†y:</label>
                        <input type="date" id="date" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary"> L∆∞u Giao D·ªãch</button>
                </form>
            </div>

            <!-- B√°o c√°o nhanh -->
            <div class="card">
                <h3> B√°o C√°o Nhanh</h3>
                <div class="form-group">
                    <label for="reportPeriod">Ch·ªçn k·ª≥ b√°o c√°o:</label>
                    <select id="reportPeriod">
                        <option value="today">H√¥m nay</option>
                        <option value="week">Tu·∫ßn n√†y</option>
                        <option value="month">Th√°ng n√†y</option>
                        <option value="year">NƒÉm n√†y</option>
                    </select>
                </div>
                <button class="btn btn-success" onclick="generateReport()"> T·∫°o B√°o C√°o</button>
                <div id="reportResult" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 5px; display: none;">
                    <h4>K·∫øt qu·∫£ b√°o c√°o:</h4>
                    <div id="reportContent"></div>
                </div>
            </div>
        </div>

        <!-- B·ªô l·ªçc giao d·ªãch -->
        <div class="filter-section">
            <h3> L·ªçc Giao D·ªãch</h3>
            <div class="filter-row">
                <div class="filter-group">
                    <label for="filterType">Lo·∫°i:</label>
                    <select id="filterType">
                        <option value="">T·∫•t c·∫£</option>
                        <option value="income">Thu nh·∫≠p</option>
                        <option value="expense">Chi ph√≠</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filterCategory">Danh m·ª•c:</label>
                    <select id="filterCategory">
                        <option value="">T·∫•t c·∫£ danh m·ª•c</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filterFromDate">T·ª´ ng√†y:</label>
                    <input type="date" id="filterFromDate">
                </div>
                <div class="filter-group">
                    <label for="filterToDate">ƒê·∫øn ng√†y:</label>
                    <input type="date" id="filterToDate">
                </div>
                <div class="filter-group">
                    <button class="btn btn-primary" onclick="applyFilters()">√Åp d·ª•ng</button>
                </div>
            </div>
        </div>

        <!-- Danh s√°ch giao d·ªãch -->
        <div class="transactions">
            <h3> L·ªãch S·ª≠ Giao D·ªãch</h3>
            <div id="transactionsList">
                <p style="text-align: center; color: #666; padding: 20px;">Ch∆∞a c√≥ giao d·ªãch n√†o. H√£y th√™m giao d·ªãch ƒë·∫ßu ti√™n!</p>
            </div>
        </div>
    </div>

    <script>
        // D·ªØ li·ªáu m·∫´u
         const categories = {
            income: ['B√°n c√† ph√™', 'D·ªãch v·ª• kh√°c', 'Khuy·∫øn m√£i', 'ƒê·ªëi t√°c'],
            expense: ['Nguy√™n li·ªáu c√† ph√™', 'Ti·ªÅn thu√™ m·∫∑t b·∫±ng', 'ƒêi·ªán n∆∞·ªõc', 'L∆∞∆°ng nh√¢n vi√™n', 'Marketing', 'Thi·∫øt b·ªã', 'V·ªá sinh', 'Kh√°c']
        };

        let transactions = [];

        document.addEventListener('DOMContentLoaded', async function () {
            await fetchTransactions();
            setupToday();
            updateCategoryOptions();
            updateFilterCategories();
            displayTransactions();
            updateStats();
            document.getElementById('type').addEventListener('change', updateCategoryOptions);
            document.getElementById('transactionForm').addEventListener('submit', addTransaction);
        });

        async function fetchTransactions() {
    try {
        const response = await fetch('http://localhost:3000/api/transactions/all');
        if (!response.ok) {
            throw new Error(`HTTP ${response.status} - ${response.statusText}`);
        }
        transactions = await response.json();
    } catch (err) {
        console.error(' L·ªói khi t·∫£i giao d·ªãch:', err); // log chi ti·∫øt
        alert('L·ªói khi t·∫£i giao d·ªãch! Vui l√≤ng ki·ªÉm tra server ho·∫∑c k·∫øt n·ªëi.');
        transactions = [];
    }
}

        async function addTransaction(e) {
            e.preventDefault();
            const transaction = {
                type: document.getElementById('type').value,
                category: document.getElementById('category').value,
                amount: parseFloat(document.getElementById('amount').value),
                description: document.getElementById('description').value,
                date: document.getElementById('date').value
            };

            try {
               await fetch('/api/transactions/add', {
             method: 'POST',
             headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(transaction)
});
                
                await fetchTransactions();
                displayTransactions();
                updateStats();
                document.getElementById('transactionForm').reset();
                setupToday();
                updateCategoryOptions();
            } catch (err) {
                alert('L·ªói khi l∆∞u giao d·ªãch!');
            }
        }

        // Hi·ªÉn th·ªã danh s√°ch giao d·ªãch
        function displayTransactions(filteredTransactions = null) {
    const transactionsList = document.getElementById('transactionsList');
    const displayTransactions = filteredTransactions || transactions;
    
    if (displayTransactions.length === 0) {
        transactionsList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Kh√¥ng c√≥ giao d·ªãch n√†o.</p>';
        return;
    }

    transactionsList.innerHTML = displayTransactions.map(transaction => `
        <div class="transaction-item">
            <div class="transaction-info">
                <div class="transaction-type ${transaction.type}">
                    ${transaction.type === 'income' ? 'üí∞' : 'üí∏'} ${transaction.category}
                </div>
                <div class="transaction-description">
                    ${transaction.description || 'Kh√¥ng c√≥ m√¥ t·∫£'}
                </div>
            </div>
            <div style="text-align: right;">
                <div class="transaction-amount ${transaction.type}">
                    ${transaction.type === 'income' ? '+' : '-'}${formatMoney(transaction.amount)}
                </div>
                <div class="transaction-date">${formatDate(transaction.date)}</div>
            </div>
            <button class="delete-btn" onclick="deleteTransaction('${transaction._id}')">X√≥a</button>
        </div>
    `).join('');
}

        // X√≥a giao d·ªãch
        async function deleteTransaction(id) {
    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a giao d·ªãch n√†y?')) {
        try {
            const response = await fetch(`http://localhost:3000/api/transactions/${id}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status} - ${response.statusText}`);
            }

            const result = await response.json();
            
            if (result.success) {
                // T·∫£i l·∫°i danh s√°ch giao d·ªãch t·ª´ server
                await fetchTransactions();
                displayTransactions();
                updateStats();
                alert('X√≥a giao d·ªãch th√†nh c√¥ng!');
            } else {
                alert('L·ªói khi x√≥a giao d·ªãch: ' + result.message);
            }
        } catch (error) {
            console.error('L·ªói khi x√≥a giao d·ªãch:', error);
            alert('L·ªói khi x√≥a giao d·ªãch! Vui l√≤ng th·ª≠ l·∫°i.');
        }
    }
}


        // C·∫≠p nh·∫≠t th·ªëng k√™
        function updateStats() {
            const totalIncome = transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const totalExpense = transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const totalProfit = totalIncome - totalExpense;
            
            const today = new Date().toISOString().split('T')[0];
            const todayTransactions = transactions.filter(t => t.date === today).length;

            document.getElementById('totalIncome').textContent = formatMoney(totalIncome);
            document.getElementById('totalExpense').textContent = formatMoney(totalExpense);
            document.getElementById('totalProfit').textContent = formatMoney(totalProfit);
            document.getElementById('todayTransactions').textContent = todayTransactions;
        }

        // √Åp d·ª•ng b·ªô l·ªçc
        function applyFilters() {
            const filterType = document.getElementById('filterType').value;
            const filterCategory = document.getElementById('filterCategory').value;
            const filterFromDate = document.getElementById('filterFromDate').value;
            const filterToDate = document.getElementById('filterToDate').value;

            let filteredTransactions = transactions;

            if (filterType) {
                filteredTransactions = filteredTransactions.filter(t => t.type === filterType);
            }

            if (filterCategory) {
                filteredTransactions = filteredTransactions.filter(t => t.category === filterCategory);
            }

            if (filterFromDate) {
                filteredTransactions = filteredTransactions.filter(t => t.date >= filterFromDate);
            }

            if (filterToDate) {
                filteredTransactions = filteredTransactions.filter(t => t.date <= filterToDate);
            }

            displayTransactions(filteredTransactions);
        }

        // T·∫°o b√°o c√°o
        function generateReport() {
            const period = document.getElementById('reportPeriod').value;
            let filteredTransactions = [];
            let periodText = '';

            const today = new Date();
            
            switch(period) {
                case 'today':
                    const todayStr = today.toISOString().split('T')[0];
                    filteredTransactions = transactions.filter(t => t.date === todayStr);
                    periodText = 'h√¥m nay';
                    break;
                    
                case 'week':
                    const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                    const weekAgoStr = weekAgo.toISOString().split('T')[0];
                    filteredTransactions = transactions.filter(t => t.date >= weekAgoStr);
                    periodText = 'tu·∫ßn n√†y';
                    break;
                    
                case 'month':
                    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                    const monthStartStr = monthStart.toISOString().split('T')[0];
                    filteredTransactions = transactions.filter(t => t.date >= monthStartStr);
                    periodText = 'th√°ng n√†y';
                    break;
                    
                case 'year':
                    const yearStart = new Date(today.getFullYear(), 0, 1);
                    const yearStartStr = yearStart.toISOString().split('T')[0];
                    filteredTransactions = transactions.filter(t => t.date >= yearStartStr);
                    periodText = 'nƒÉm n√†y';
                    break;
            }

            const income = filteredTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const expense = filteredTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const profit = income - expense;

            document.getElementById('reportResult').style.display = 'block';
            document.getElementById('reportContent').innerHTML = `
                <p><strong>B√°o c√°o ${periodText}:</strong></p>
                <p> T·ªïng thu nh·∫≠p: <span class="income">${formatMoney(income)}</span></p>
                <p> T·ªïng chi ph√≠: <span class="expense">${formatMoney(expense)}</span></p>
                <p> L·ª£i nhu·∫≠n: <span class="${profit >= 0 ? 'income' : 'expense'}">${formatMoney(profit)}</span></p>
                <p> S·ªë giao d·ªãch: ${filteredTransactions.length}</p>
            `;
        }

        

        // Format ti·ªÅn t·ªá
        function formatMoney(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        // Format ng√†y th√°ng
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN');
        }
        function setupToday() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date').value = today;
}

function updateCategoryOptions() {
    const type = document.getElementById('type').value;
    const categorySelect = document.getElementById('category');
    
    categorySelect.innerHTML = '<option value="">Ch·ªçn danh m·ª•c</option>';
    
    if (type && categories[type]) {
        categories[type].forEach(cat => {
            categorySelect.innerHTML += `<option value="${cat}">${cat}</option>`;
        });
    }
}

function updateFilterCategories() {
    const filterCategory = document.getElementById('filterCategory');
    const allCategories = [...categories.income, ...categories.expense];
    
    filterCategory.innerHTML = '<option value="">T·∫•t c·∫£ danh m·ª•c</option>';
    allCategories.forEach(cat => {
        filterCategory.innerHTML += `<option value="${cat}">${cat}</option>`;
    });
}
fetch('http://localhost:3000/api/transactions/all')
  .then(response => response.json())
  .then(data => console.log(data))
  .catch(error => console.error('L·ªói:', error));
    </script>
</body>
</html>